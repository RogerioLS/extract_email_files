import os
import warnings

import pandas as pd
from colorama import Fore
from dotenv import load_dotenv

from source.email.envia_email_alerta import enviar_email_alerta
from source.email.envia_email_sucesso import enviar_email_sucesso
from source.email.extrair_excel_email import extrair_excel_email
from source.logger.logger_config import logger_quantum, print_log
from source.manipulacao_excel.manipulacao_excel import processar_excel_extraido

warnings.filterwarnings("ignore", category=UserWarning, module="openpyxl")

# --- CONFIGURA√á√ÉO INICIAL ---
# Carrega as vari√°veis de ambiente do arquivo .env
load_dotenv()

# Define uma cor tema para os logs desta execu√ß√£o
THEME_COLOR = Fore.MAGENTA

# Carrega as vari√°veis de ambiente necess√°rias
PASTA_RAIZ_QUANTUM = os.getenv("PASTA_RAIZ_QUANTUM")
HEADLINE_PREFIX = os.getenv("HEADLINE_PREFIX")


def main():
    # --- ETAPA 1: Extrair anexo do e-mail ---
    print_log(
        "A√á√ÉO", "Iniciando extra√ß√£o de anexo do e-mail...", theme_color=THEME_COLOR
    )
    extrair_excel_email(PASTA_RAIZ_QUANTUM, HEADLINE_PREFIX)
    logger_quantum.info("Extra√ß√£o de e-mail conclu√≠da.")

    # --- ETAPA 2: Processar a planilha e verificar a qualidade dos dados ---
    limites_null = 30
    print_log(
        "A√á√ÉO",
        f"Processando planilha e verificando se h√° mais de {limites_null} valores nulos...",
        theme_color=THEME_COLOR,
    )
    resultado_processamento = processar_excel_extraido(PASTA_RAIZ_QUANTUM, limites_null)
    logger_quantum.info("Processamento da planilha conclu√≠do.")

    # --- ETAPA 3: Tomar decis√£o com base na qualidade dos dados ---
    if not isinstance(resultado_processamento, pd.DataFrame):
        # CASO DE FALHA: Muitos valores nulos
        contagem_nan = resultado_processamento
        print_log(
            "AVISO",
            f"Limite de valores nulos excedido! Encontrados: {contagem_nan}. Limite: {limites_null}.",
        )
        logger_quantum.error(
            f"Valida√ß√£o falhou: {contagem_nan} valores nulos encontrados (limite: {limites_null})."
        )

        print_log("A√á√ÉO", "Enviando e-mail de alerta...", theme_color=THEME_COLOR)
        enviar_email_alerta(contagem_nan, limites_null)
        logger_quantum.info("E-mail de alerta enviado.")
        return print_log(
            "INFO",
            "‚ùå --- PROCESSO QUANTUM INTERROMPIDO DEVIDO A ERRO --- ‚ùå",
            theme_color=THEME_COLOR,
        )
    else:
        # CASO DE SUCESSO: Dados v√°lidos
        print_log(
            "A√á√ÉO",
            "Enviando e-mail de confirma√ß√£o de sucesso...",
            theme_color=THEME_COLOR,
        )
        enviar_email_sucesso()
        logger_quantum.info("E-mail de sucesso enviado.")
        return print_log(
            "INFO",
            "‚úÖ --- PROCESSO QUANTUM CONCLU√çDO COM SUCESSO --- ‚úÖ",
            theme_color=THEME_COLOR,
        )


if __name__ == "__main__":
    print_log(
        "INFO", "üöÄ --- INICIANDO PROCESSO QUANTUM --- üöÄ", theme_color=THEME_COLOR
    )
    logger_quantum.info("Processo Quantum iniciado.")

    try:
        main()
    except Exception as e:
        # Tratamento de erro para qualquer falha inesperada no processo
        print_log("ERROR", f"Ocorreu um erro cr√≠tico que interrompeu o processo: {e}")
        logger_quantum.error(f"Erro fatal na execu√ß√£o do main.py: {e}", exc=e)
        print_log(
            "INFO",
            "‚ùå --- PROCESSO QUANTUM INTERROMPIDO DEVIDO A ERRO --- ‚ùå",
            theme_color=THEME_COLOR,
        )
        raise
